---
section: technology
date: Last Modified
title: "Cross-Domain Mesaj İletimi"
lang: "tr"
permalink: "technology/bridge/cross-domain-messaging"
whatsnext: { "Yatırım Geçitleri(Deposit Gateways)": "/tr/technology/bridge/deposit-gateways/" }
---

import ClickToZoom from "../../../../../components/ClickToZoom.astro"
import Aside from "../../../../../components/Aside.astro"
import ToggleElement from "../../../../../components/ToggleElement.astro"

import L1ToL2 from "../_images/L1-to-L2.png"
import L2ToL1 from "../_images/L2-to-L1.png"
import WithdrawTrie from "../_images/withdraw-trie.png"

Scroll, L1(katman 1) ile L2(katman 2) arasında token transferlerini sağlayan ve dapp'lerin iletişim kurmasını sağlayan keyfi bir mesaj iletim köprüsüne sahiptir. Bu, katman 1'deki dapp'lerin katman 2'deki akıllı kontrat işlevlerini tetikleyebileceği anlamına gelir ve bunun tersi de geçerlidir. Şimdi, mesajların katman 1 ve katman 2 arasında nasıl iletildiğini açıklayacağız.

## L1'den L2'ye Mesaj Gönderme

<ClickToZoom src={L1ToL2} alt="L1 to L2 workflow" caption="Figure 1. L1 to L2 message relay workflow" />

Katman 1'den Katman 2'ye mesaj göndermek için iki temel yaklaşım vardır: `L1ScrollMessenger` aracılığıyla keyfi mesajlar göndermek ve `EnforcedTxGateway` aracılığıyla zorunlu işlemler göndermek. Her iki yaklaşım da kullanıcıların L1'de bir L2 işlemi başlatmasına ve L2'de keyfi bir kontratı çağırmasına izin verir. Keyfi mesajlar için, L2 işlemlerinin göndericisi, takma adlı `L1ScrollMessenger` adresidir. Zorunlu işlemler için ise, L2 göndericisi harici bir sahip hesabıdır (EOA). Ayrıca, kullanıcıların ETH ve ERC-20, ERC-677, ERC-721 ve ERC-1155 gibi standart token'ları yatırmasını kolaylaştırmak için birkaç standart token giriş kapısı sağlıyoruz. Temelde, bu kapılar, token yatırımlarını bir mesaja kodlar ve bunları L2'deki karşıtlarına `L1ScrollMessenger` sözleşmesi aracılığıyla gönderir. L1 token kapıları hakkında daha fazla ayrıntıya [Deposit Gateways](/technology/bridge/deposit-gateways) bölümünde ulaşabilirsiniz.

<Aside type="danger" title="">
Zorunlu İşlemler henüz Scroll'da etkinleştirilmemiştir. Gelecekteki güncellemelerde, kullanıcılar bu işlevselliği kullanarak `L1ScrollMessenger`'ı atlayabilir ve mesajları doğrudan `L1MessageQueue`'ye gönderebilirler.
</Aside>

Şekil 1'de gösterildiği gibi, keyfi mesajlar ve zorunlu işlemler, `L1MessageQueue` sözleşmesinde depolanan mesaj kuyruğuna eklenir. `L1MessageQueue` sözleşmesi, sırasıyla keyfi mesajları ve zorunlu işlemleri eklemek için `appendCrossDomainMessage` ve `appendEnforcedTransaction` adında iki fonksiyon sağlar.

```solidity
/// @notice Sözleşmeye L1'den L2'ye keyfi bir mesaj ekle.
/// @param target L2 hedef adresi.
/// @param gasLimit Bu işlem için L2'de kullanılacak maksimum gaz miktarı.
/// @param data L1'den başlatılan işlemin calldata'sı
function appendCrossDomainMessage(
    address target,
    uint256 gasLimit,
    bytes calldata data
) external;

/// @notice Sözleşmeye L1'den L2'ye zorunlu bir işlem ekle.
/// @param sender Bu işlemin göndericisi.
/// @param target Bu işlemin hedefi.
/// @param value L2'ye aktarılacak değer.
/// @param gasLimit Bu işlem için L2'de kullanılacak maksimum gaz miktarı.
/// @param data L1'den başlatılan işlemin calldata'sı
function appendEnforcedTransaction(
    address sender,
    address target,
    uint256 value,
    uint256 gasLimit,
    bytes calldata data
) external;
```

Her iki fonksiyon da, Scroll zincirinde tanıtılan yeni bir işlem türü olan `L1MessageTx` ile L1 tarafından başlatılan bir işlem oluşturur ve işlem hash'ini hesaplar (daha fazla ayrıntı için [L1 Mesaj İşlemi](/technology/chain/transactions#l1-message-transaction) bölümüne bakınız). `L1MessageQueue` daha sonra işlem hash'ini mesaj kuyruğuna ekler ve `QueueTransaction(sender, target, value, queueIndex, gasLimit, calldata)` etkinliğini yayınlar. L1 mesaj işlemlerinin oluşturulması sırasında `appendCrossDomainMessage` ve `appendEnforcedTransaction` arasındaki fark şudur:

- `appendCrossDomainMessage`, yalnızca `L1ScrollMessenger` tarafından çağrılabilir ve işlem göndereni olarak `msg.sender`'ın aliase edilmiş adresini kullanır, ki bu da `L1ScrollMessenger`'ın adresi olacaktır.
- `appendEnforcedTransaction`, yalnızca `EnforcedTxGateway` tarafından çağrılabilir ve işlem göndereni olarak işlev parametresinden `sender`'ı kullanır. Bu, kullanıcıların L1 köprüsü üzerinden doğrudan L2 hesaplarından ETH çekme veya aktarma işlemlerini zorlamasına olanak tanır.

İşlem başarıyla L1'de gerçekleştirildikten sonra, `L1MessageQueue` sözleşmesini izleyen Scroll sıralayıcısındaki izleyici, L1 bloklarından yeni `QueueTransaction` etkinliklerini toplar. Sıralayıcı daha sonra her etkinlik için yeni bir `L1MessageTx` işlemi oluşturur ve bunları yerel L1 işlem kuyruğuna ekler. Yeni bir L2 bloğu oluşturulurken, sıralayıcı hem L1 işlem kuyruğundan hem de L2 bellek havuzundan işlemleri içerir. L1 mesaj işlemlerinin `L1MessageQueue` sözleşmesindeki L1 mesaj kuyruğu sırasına dayanarak sırayla dahil edilmesi gerektiğini unutmayın. `L1MessageTx` işlemleri her zaman L2 bloklarında L2 işlemlerinden önce gelir. Şu anda, bir L2 bloğundaki `L1MessageTx` işlemlerinin sayısını `NumL1MessagesPerBlock` (şu anda 10 olarak ayarlanmış) ile sınırlıyoruz.

Şimdi, `L1ScrollMessenger` aracılığıyla keyfi mesajların gönderilmesi ve `EnforcedTxGateway` aracılığıyla zorunlu işlemlerin gönderilmesi sürecine daha fazla açıklık getireceğiz.

### Bir Keyfi Mesaj Göndermek

`L1ScrollMessenger` kontratı, keyfi mesajları göndermek için iki `sendMessage` fonksiyonu sağlar. Tek fark, ikincisinin kullanıcılara gönderen adres dışında bir geri ödeme adresi belirtmelerine izin vermesidir, böylece bir ücret iadesi alabilirler.

<ToggleElement anchor="sendMessage function signatures">
<div slot="title"><code>sendMessage</code> function signatures</div>
```solidity
/// @param target The target address on L2.
/// @param value The value to deposit to L2 from `msg.value`.
/// @param message The message passed to target contract.
/// @param gasLimit The maximum gas can be used for this transaction on L2.
function sendMessage(
    address target,
    uint256 value,
    bytes memory message,
    uint256 gasLimit
) external payable;

/// @param target The target address on L2.
/// @param value The value to deposit to L2 from `msg.value`.
/// @param message The message passed to target contract.
/// @param gasLimit The maximum gas can be used for this transaction on L2.
/// @param refundAddress The address to refund excessive fee on L1.
function sendMessage(
    address target,
    uint256 value,
    bytes calldata message,
    uint256 gasLimit,
    address refundAddress
) external payable;
````
</ToggleElement>

Her iki fonksiyon da, L2'de ilgili `L1MessageTx` işlemi için bir gaz limiti sağlamak ve L1'de **message relay fee** ön ödemek için kullanıcıların gereksinimleri vardır. Bu ücret, gaz limiti miktarına dayalı olarak hesaplanır. Ücret, L1'deki bir `feeVault` kontratına toplanır. Kullanıcı, L2'de işlem başarısız olduğunda, işlemin L1'de doğru gaz limitini ayarlamadığı için, aynı mesajı daha yüksek bir gaz limitiyle yeniden gönderebilir. Başarısız işlemlerin tekrar denendiği hakkında daha fazla bilgiyi **Başarısız işlemlerin tekrar denenmesi** bölümünde bulabilirsiniz, ancak bu ücretlerin kullanılmayan kısmının kullanıcıya iade edilmesi nedeniyle, gaz limitinin fazla tahmin edilmesi için ceza yoktur.

`sendMessage` fonksiyonları, argümanları bir çapraz alan mesajına kodlar (aşağıdaki kod örneğine bakın), burada mesaj nonce, L1 mesaj sırasının bir sonraki sırasıdır. Kodlanmış veriler, L2'de yürütülen `L1MessageTx` işleminde calldata olarak kullanılır. Bu tür çapraz alan mesajlarının her zaman L2'deki `L2ScrollMessenger` kontratının `relayMessage` fonksiyonunu çağırdığını unutmayın.

```solidity
abi.encodeWithSignature(
    "relayMessage(address,address,uint256,uint256,bytes)",
    _sender,
    _target,
    _value,
    _messageNonce,
    _message
)
````

`value` tutarındaki yatırılan ETH, `L1ScrollMessenger` kontratında kilitlenir. Mesajdaki ETH miktarı, mesaj iletim ücretini ve yatırılan tutarı karşılayamazsa, işlem geri alınır. `L1ScrollMessenger` kontratı, fazla tutarı belirlenen `refundAddress` veya başka bir işlem gönderene iade eder. Son olarak, `L1ScrollMessenger`, cross-domain mesajı `appendCrossDomainMessage` yöntemi aracılığıyla `L1MessageQueue`'ye ekler.

### Bir Zorunlu İşlem Göndermek

<Aside type="danger" title="">

Zorunlu İşlemler henüz Scroll'da etkin değil. Gelecekteki güncellemelerde, kullanıcılar bu işlevselliği kullanarak `L1ScrollMessenger`'ı atlayıp mesajları doğrudan `L1MessageQueue`'ya gönderebilecekler.
</Aside>

`EnforcedTxGateway` sözleşmesi, zorunlu bir işlem göndermek için iki `sendTransaction` işlevi sağlar. İlk işlevde, oluşturulan `L1MessageTx` işleminin göndereni işlem gönderenidir. Diğer yandan, ikinci işlev, gönderen olarak geçirilen `sender` adresini `L1MessageTx` işleminin göndereni olarak kullanır. Bu, bir üçüncü tarafın kullanıcı adına zorunlu bir işlem göndermesine ve aktarım ücretini ödemesine olanak tanır. İkinci işlev, oluşturulan `L1MessageTx` işleminin `sender` adresiyle eşleşen geçerli bir imza sağlanmasını gerektirir. Her iki `sendTransaction` işlevi de gönderenin bir EOA hesabı olmasını zorunlu kılar.

<ToggleElement anchor="sendTransaction function signatures">
<div slot="title"><code>sendTransaction</code> function signatures</div>

```solidity
/// @param target The target address on L2.
/// @param value The value to withdraw from the `tx.origin` address on L2.
/// @param gasLimit The maximum gas can be used for this transaction on L2.
/// @param data The calldata passed to target contract.
function sendTransaction(
    address target,
    uint256 value,
    uint256 gasLimit,
    bytes calldata data
) external payable;

/// @param sender The sender address who will initiate this transaction on L2.
/// @param target The target address on L2.
/// @param value The value to withdraw from the `sender` address on L2.
/// @param gasLimit The maximum gas can be used for this transaction on L2.
/// @param data The calldata passed to target contract.
/// @param signature The signature for the corresponding `L1MessageTx` transaction.
/// @param refundAddress The address to refund excessive fee on L1.
function sendTransaction(
    address sender,
    address target,
    uint256 value,
    uint256 gasLimit,
    bytes calldata data,
    bytes memory signature,
    address refundAddress
) external payable;
```

</ToggleElement>

Keyfi mesaj iletimine benzer şekilde, `sendTransaction` işlemi mesaj iletme ücretini keser ve bunu L1 `feeVault` hesabına transfer eder. Ancak önemli bir fark, işleve iletilen `value`'nin L2'deki gönderici hesabından aktarılacak ETH miktarını belirtmesidir, L1'deki değil. Dolayısıyla, `msg.value`, yalnızca mesaj iletme ücretini kapsamalıdır. Eğer mesajdaki ETH miktarı ücreti karşılayamazsa, işlem başarısız olacaktır. İlk işlevde herhangi bir fazla ücret işlem göndericisine, ikinci işlevde ise `refundAddress`'e iade edilir. Son olarak, `EnforcedTxGateway`, işlemi mesaj kuyruğuna eklemek için `L1MessageQueue.appendEnforcedTransaction`'ı çağırır.

### Başarısız Mesajları Tekrar Deneme

Başarısız bir `L1MessageTx` işlemi, yetersiz gaz nedeniyle L2'de başarısız olursa, kullanıcılar aynı bilgileri daha yüksek bir gaz sınırıyla tekrar gönderebilirler. `L1ScrollMessenger`, kullanıcıların önceki başarısız işleme aynı bilgileri daha yüksek bir gaz limitiyle yeniden göndermelerini sağlayan `replayMessage` yöntemini sağlar. Bu ileti, L2'de yeni bir `L1MessageTx` işlemi haline gelir. Önceki başarısız işlem için gaz ücretini iade etmeyeceğiz çünkü işlem zaten L2'de işlenmiştir.

<ToggleElement anchor="replayMessage function signature">
<div slot="title"><code>replayMessage</code> function signature</div>

```solidity
/// @param from The address of the sender of the message.
/// @param to The address of the recipient of the message.
/// @param value The msg.value passed to the message call.
/// @param queueIndex The queue index for the message to replay.
/// @param message The content of the message.
/// @param newGasLimit New gas limit to be used for this message.
/// @param refundAddress The address of account who will receive the refunded fee.
function replayMessage(
    address from,
    address to,
    uint256 value,
    uint256 queueIndex,
    bytes memory message,
    uint32 newGasLimit,
    address refundAddress
) external payable;
```

</ToggleElement>

`L2ScrollMessenger` sözleşmesi L1'den başarıyla iletilen tüm L1 mesajlarını kaydettiği için, yeniden gönderilen mesajın işlemi, orijinal mesajın başarılı olması durumunda L2'de geri alınır.

### Mesaj İletim Ücreti

L1'deki `L2GasPriceOracle` sözleşmesi, bir mesajın gaz limiti verildiğinde iletişim ücretini hesaplar. Bu sözleşme, şu anda Scroll tarafından çalıştırılan özel bir iletici tarafından güncellenen `l2BaseFee`'yi depolar. L1'den L2'ye iletilen mesajların iletişim ücreti `gasLimit * l2BaseFee` şeklindedir.

<Aside type="tip" title="Upgrade Notice">
Şubat 2024 Köprü Güncellemesi sırasında, `L2GasPriceOracle` kaldırılacak ve işlevselliği `L1MessageQueueWithGasPriceOracle` sözleşmesine taşınacaktır.

Güncelleme, iki haftalık bir zaman kilitlenmesinden sonra 21 Şubat 2024 tarihinde tamamlanması beklenmektedir. Scroll Sepolia bu güncellemeyi zaten geçirdi. Daha fazla bilgiye [buradan](https://scroll.io/blog/protocol-upgrade-bridging-cost-reduction) ulaşabilirsiniz.
</Aside>

### Adres Takma Adı

`CREATE` opcode'nun davranışı nedeniyle, birinin L1 ve L2'de aynı adrese farklı bytecode ile bir kontrat dağıtması mümkündür. Kötü niyetli kullanıcıların bundan faydalanmasını önlemek için, köprü bir mesaj göndereni L1'de bir kontratsa bir adres takma adı uygular. L1 mesaj işleminin takma gönderen adresi `l1_contract_address + offset` şeklindedir, burada offset değeri `0x1111000000000000000000000000000000001111`'dir.

## L2'den L1'e Mesaj Göndermek

<ClickToZoom src={L2ToL1} alt="L2 to L1 workflow" caption="Figure 2. L2 to L1 message relay workflow" />

L2'de, kullanıcılar `L2ScrollMessenger` aracılığıyla istedikleri tokenleri çekmek ve L1 kontratlarını çağırmak için keyfi mesajlar gönderebilirler. L1'de olduğu gibi, birkaç standart token çıkış kapısı oluşturduk ki bu, token çekme işlemlerini başlatmayı daha kolay hale getirir. L2 token çıkış kapıları hakkında daha fazla bilgi için Çekim Kapıları(Withdraw Gateways) bölümüne başvurun.

`L2ScrollMessenger` kontratı ayrıca bir `sendMessage` fonksiyonu sağlar. `L1ScrollMessenger.sendMessage` ile farkı, fonksiyonda `gasLimit` parametresinin yoksayılmasıdır; çünkü token çekme yürütme işlemi L1'de kullanıcılar tarafından gönderilir ve işlem ücreti doğrudan L1'de ödenir. Dolayısıyla, `sendMessage` fonksiyonu, `msg.value`'nin parametre `value` ile eşit olmasını gerektirir. Fonksiyon, argümanları aynı şema doğrultusunda cross-domain mesajına kodlar.

<ToggleElement anchor="sendMessage function signatures">
<div slot="title"><code>sendMessage</code> function signatures</div>

```solidity
/// @param target The target address on L1.
/// @param value The value to withdraw to L1 from `msg.value`.
/// @param message The message passed to target contract.
/// @param _gasLimit Ignored in the L2ScrollMessenger because the withdrawal execution on L1 is done by the user.
function sendMessage(
    address target,
    uint256 value,
    bytes memory message,
    uint256 _gasLimit
) external payable;
```

</ToggleElement>

Sonraki adımda, çapraz domain mesajın hash'ı, `L2MessageQueue`'ye `appendMessage` fonksiyonunu çağırarak eklenir. `L2MessageQueue` kontratı, Çekim Trie olarak adlandırılan, eklemeye açık bir Merkle ağacını sürdürür. Yeni bir mesaj kuyruğa eklendiğinde, kontrat, onu Çekim Trie'ye ekler ve ağacın kök hash'ini günceller.

Kullanıcıların L2'den L1'e mesajlar içeren işlem paketleri, L1 rollup kontratında finalize edildikten sonra, kullanıcılar, L1'de çekiş işlemini gerçekleştiren `L1ScrollMessenger` kontratındaki `relayMessageWithProof` yöntemini çağırmak için karşılık gelen Çekim İşlemini Gerçekleştirme işlemlerini göndermelidirler. Merkle kanıtları sayesinde, L1'de çekiş işlemlerinin finalizasyonu güvenilir ve kullanıcılar tarafından kendileri veya üçüncü taraflar tarafından kullanıcı adına gönderilebilir.

Çekim MIP'sini oluşturmayı kolaylaştırmak için, Scroll, Bridge History API adlı bir hizmeti sürdürür. Bridge History API, `L2ScrollMessenger` tarafından yayınlanan `SentMessage` etkinliklerini izler ve dahili olarak bir Çekim Trie sürdürür. Her çekiş mesajı için sürekli olarak Merkle kanıtları oluşturur. Kullanıcılar ve üçüncü taraf hizmetleri, _Çekim Gerçekleştirme_ işlemlerine dahil etmek için Bridge History API'den Merkle kanıtlarını sorgulayabilirler.

Çekim işlemlerinin gerçekleştirilme işlemleri, kullanıcılar tarafından kendileri veya üçüncü taraf hizmetleri tarafından gönderilebilir.

### Çekim Trie'si

<ClickToZoom src={WithdrawTrie} alt="Withdraw Trie structure" caption="Figure 3. Withdraw Trie structure" />

Çekim Trie yoğun bir ikili Merkle ağacıdır. Bir yaprak düğümünün hash'ı, mesaj hash'inden gelir, bir yaprak olmayan düğümün hash'i ise iki çocuğunun hash'lerinin birleştirilmiş hash'lerinin Keccak hash özeti olarak alınır. Çekim Trie'nin derinliği, trie'ye eklenen mesajların sayısına bağlı olarak dinamik olarak büyür.

Şekil 3(a), tam bir 3 katmanlı çekim ağacının bir örneğini göstermektedir. Yaprak düğümlerin tam bir ikili ağacı doyuramadığı durumlarda, Şekil 3(b) ve 3(c)'de gösterildiği gibi yaprak düğümleri hash 0 ile doldururuz. Bir mesajı tamamlanmamış bir Çekim Trie'ye eklerken, dolgu düğümü daha sonra gerçek mesaj hash'ı ile değiştirilecektir.
